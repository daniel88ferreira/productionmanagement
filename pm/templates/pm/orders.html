{% extends 'pm/base.html' %}

{% load crispy_forms_tags %}

{% block title %}Ordens de Produção{% endblock %}

{% block content %}

    <div class="row">
        <div class="col-xs-6">
            <h3 class="h3">Ordens de Produção</h3>
            <h5 class="h5">status: "todo"</h5>
        </div>
        <div class="col-xs-6 text-right" id="notification">
        </div>
    </div>
    <br>

    <div class="row">
        <div class="col-xs-6">
            <a class="btn btn-primary" href="{% url 'pm:create_order' %}">Criar Nova</a>
            <div class="btn-group">
                <a href="#" class="btn btn-default">{{ target }}</a>
                <a class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                    <span class="caret"></span></a>
                <ul class="dropdown-menu">
                    <li><a href="{% url 'pm:orders'%}">Base</a></li>
                    <li><a href="{% url 'pm:orders'%}?target=ALL">Todas</a></li>
                    <li><a href="#">Another action</a></li>
                    <li><a href="#">Something else here</a></li>
                    <li class="divider"></li>
                </ul>
            </div>
        </div>
        <div class="col-xs-6 text-right">
            <a class="btn btn-danger" href="#">Cancelar Ordem de Execução</a>
            <a class="btn btn-info" id="create-exec-order">Criar Ordem de Execução</a>
        </div>
    </div>

    <br>

    <table class="table table-striped table-hover ">
            <thead>
            <tr>
                <th>Data</th>
                <th>Número</th>
                <th>Descrição</th>
                <th>Estado</th>
            </tr>
            </thead>
            <tbody>
            {% for order in all_orders_list %}
                <tr>
                    <td>{{ order.date }}</td>
                    <td>{{ order.number }}</td>
                    <td>{{ order.description }}</td>
                    <td>{{ order.status }}</td>
                    <td align="right">
                        <form action="" method="POST" id="exec-form_{{ order.id }}">
                            {% csrf_token %}
                            {% if False %}
                                <button class="btn btn-danger btn-xs" type="submit" id="add-to-exec_{{ order.id }}">
                                    Remove
                                </button>
                            {% else %}
                                <button class="btn btn-success btn-xs" type="submit" id="add-to-exec_{{ order.id }}">
                                    Add
                                </button>
                            {% endif %}
                            <button class="btn btn-primary btn-xs"
                                    type="submit"
                                    data-href="{% url 'pm:order_detail' order.id %}"
                                    id="view_{{ order.id }}">View</button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

{% endblock %}

{% block javascript %}
    <script type = "text/javascript">
        var notificationTimeout = null;
        var execution_order = null;

        function checkIfExecutionOrderIsStaged() {
            $.ajax({
                    url: window.location.href,
                    type: "POST", // http method
                    data: {
                        csrfmiddlewaretoken: csrftoken,
                        action: "check-status"
                    },
                    success: function (json) {
                        showNotification('success', 'status:' + json['status'] + 'number: ' + json['exec_order_number']);
                    }
                });
            return true
        }

        function showNotification(severity, text) {
            var notification_html = '<div class="col-xs-6 text-right" id="notification">' +
                '<div class="alert alert-dismissible alert-'+severity+'">' +
                '<button type="button" class="close" data-dismiss="alert">&times;</button>' +
                text +
                '</div>' +
                '</div>';
            $("#notification").replaceWith(notification_html);
            clearTimeout(notificationTimeout);
            notificationTimeout = setTimeout(removeNotification, 3000);
        }

        function removeNotification() {
            var notification_html = '<div class="col-xs-6 text-right" id="notification"></div>';
            $("#notification").html(notification_html);
        }
        //For getting CSRF token
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        $(document).ready(function() {
            //When add button is clicked
            $("#create-exec-order").click(function(e) {
                e.preventDefault();

                var csrftoken = getCookie('csrftoken');
                var this_button = $(this);
                $.ajax({
                    url: window.location.href,
                    type: "POST", // http method
                    data: {
                        csrfmiddlewaretoken: csrftoken,
                        action: "create-exec-order"
                    },
                    success: function (json) {
                        this_button.text("Ver Ordem de Execução");
                        this_button.removeClass("btn-info");
                        this_button.addClass("btn-success");
                        this_button.attr('id', 'view-exec-order');
                        showNotification('success', 'Numero: ' + json['exec_order_number']);
                    }
                });
            });

            //When add button is clicked
            $("button[id^='add-to-exec_']").click(function(e) {
                e.preventDefault();

                var csrftoken = getCookie('csrftoken');
                var order_id = this.id.split("_")[1];
                var this_button = $(this);
                $.ajax({
                    url: window.location.href,
                    type: "POST", // http method
                    data: {
                        csrfmiddlewaretoken: csrftoken,
                        action: "add-to-exec-order",
                        order_id: order_id
                    },
                    success: function (json) {
                        this_button.text("Remove");
                        this_button.removeClass("btn-success");
                        this_button.addClass("btn-danger");
                        showNotification('success', 'Hi, this is the message: ' + json['message'] + '!.');
                    }
                });
            });

            $("button[id^='view_']").click(function(e) {
                e.preventDefault();
                window.document.location = $(this).data("href");
            });
        });
    </script>
{% endblock %}

